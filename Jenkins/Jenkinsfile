pipeline {
  agent any

   environment{
        SONAR_HOME = tool "sonar"
    }

  stages {
    stage ('Cleanup Working Directory') {
      steps {
        script {
          cleanWs()
        }
      }
    }

    stage ('Trivy File Scan') {
      steps {
        sh "trivy fs --format table -o fs.html ."         
      }
    }

    stage('SonarQube: Code Analysis') {
      steps {
        withSonarQubeEnv("sonar"){
          sh "$SONAR_HOME/bin/sonar-scanner -Dsonar.projectName=bookstore -Dsonar.projectKey=bookstore -X"
        }
      }
    }
        
    stage("SonarQube: Code Quality Gates"){
      steps {
        timeout(time: 5, unit: "MINUTES"){
          waitForQualityGate abortPipeline: false
        }
      }
    }
  }
}